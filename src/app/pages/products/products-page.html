<!-- Products Page -->
<div class="products-page mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3" style="max-width: 1300px; width: 100%;">
    <h2 class="fw-bold m-0">Productos</h2>
    <div class="profit-row" style="gap: 0.5rem;">
      <span class="profit-label">Profit esperado</span>
      <input type="number" class="form-control form-control-sm" style="width: 70px;" [(ngModel)]="desideradProfitPorcentage" min="0" max="100" step="1" />
      <span class="small text-muted">%</span>
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="table-responsive d-flex flex-column align-items-center position-relative">
    <table class="table table-sm align-middle products-table" style="max-width: 1300px; min-width: 900px; width: 100%;">
      <colgroup>
        <col class="col-id" />
        <col class="col-name" />
        <col class="col-unitprice" />
        <col class="col-stock" />
        <col class="col-unit" />
        <col class="col-recipeitems" />
        <col class="col-cost" />
        <col class="col-recommended" />
        <col class="col-acciones" />
      </colgroup>
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Nombre</th>
          <th scope="col">Precio</th>
          <th scope="col">Stock</th>
          <th scope="col">Unidad</th>
          <th scope="col">Receta</th>
          <th scope="col" class="col-details">Detalles</th>
          <th scope="col">Costo unitario</th>
          <th scope="col">Precio recom.</th>
          <th scope="col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (product of products; track product.id) {
          <tr>
            <th scope="row">{{ product.id }}</th>
            <td>{{ product.name }}</td>
            <td>{{ product.price | currency:'ARS':'symbol':'1.2-2' }}</td>
            <td>{{ product.currentStock }}</td>
            <td>{{ product.unit.name }}</td>
            <!-- Dropdown de receta -->
            <td class="dropend">
              <button
                class="btn btn-secondary dropdown-toggle w-100 d-flex align-items-center gap-2"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                data-bs-auto-close="outside"
              >
                <i class="bi bi-list-ul"></i>Receta
              </button>
              <ul class="dropdown-menu p-3">
                @for (item of product.recipeItems; track item.id) {
                  <li class="dropdown-row">
                    <span class="property">{{ item.ingredient.name }}</span>
                    <span class="value">x {{ item.quantity }}</span>
                  </li>
                }
              </ul>
            </td>
            <!-- Dropdown de detalles -->
            <td class="dropend">
              <button
                class="btn btn-secondary dropdown-toggle w-100 d-flex align-items-center gap-2"
                type="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                data-bs-auto-close="outside"
              >
                <i class="bi bi-info-circle"></i>Detalles
              </button>
              <ul class="dropdown-menu p-3">
                <li class="dropdown-row">
                  <span class="property">Unidades/Receta:</span>
                  <span class="value">{{ product.unitsPerRecipe }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">Horas Labor/Receta:</span>
                  <span class="value">{{ product.laborHoursPerRecipe }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">Kilos/mes:</span>
                  <span class="value">{{ product.expectedKilosPerMonth }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">Complejidad:</span>
                  <span class="value">{{ product.complexityFactor }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">CIF unitario:</span>
                  <span class="value">{{ product.unitaryCif | currency:'ARS':'symbol':'1.2-2' }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">Labor unitario:</span>
                  <span class="value">{{ product.unitaryLaborCost | currency:'ARS':'symbol':'1.2-2' }}</span>
                </li>
                <li class="dropdown-row">
                  <span class="property">Costo receta:</span>
                  <span class="value">{{ product.recipeCost | currency:'ARS':'symbol':'1.2-2' }}</span>
                </li>
              </ul>
            </td>
            <!-- Costo unitario fuera del dropdown -->
            <td>{{ product.unitCost | currency:'ARS':'symbol':'1.2-2' }}</td>
            <!-- Precio recomendado = costo unitario + profit -->
            <td>
              {{ (product.unitCost * (1 + (desideradProfitPorcentage || 0) / 100)) | currency:'ARS':'symbol':'1.2-2' }}
            </td>
            <td>
              <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-sm btn-accent rounded-3" (click)="openProductEditModal(product)">Editar</button>
                <button class="btn btn-sm btn-danger rounded-3" (click)="deleteProduct(product)">Eliminar</button>
                <button class="btn btn-sm btn-accent rounded-3" (click)="openStockMovementModal(product)">Â±Stock</button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="actions-pagination-row d-flex align-items-center justify-content-between mt-3 gap-3 mx-auto" style="position: relative; min-height: 48px; max-width: 900px; min-width: 700px; width: 100%;">
    <div>
      <button class="btn btn-accent btn-sm" (click)="openProductCreateModal()">+ Registrar nuevo producto</button>
    </div>
    <app-pagination
      [page]="page"
      [hasNext]="hasNext"
      (previous)="previousPage()"
      (next)="nextPage()"
      style="position: absolute; left: 50%; transform: translateX(-50%) translateY(-8px);"
    ></app-pagination>
    <div class="d-flex gap-2">
      <button class="btn btn-accent btn-sm" (click)="showCreateUnitModal = true">+ Unidad</button>
    </div>
  </div>
<!-- Modal Unidad -->
@if (showCreateUnitModal) {
  <app-unit-form
    [unitScope]="unitScope"
    (cancel)="showCreateUnitModal = false">
  </app-unit-form>
}
</div>

<!-- Modal Crear/Editar Producto -->
@if (showProductModal) {
  <app-product-form
    [product]="selectedProduct"
    (create)="onCreateProduct()"
    (update)="onUpdateProduct()"
    (cancel)="showProductModal = false">
  </app-product-form>
}
@if (showStockMovementModal) {
  <app-stock-movement-form
    [product]="selectedProduct"
    (updateStock)="updateSelectedProductStock($event)"
    (cancel)="showStockMovementModal = false">
  </app-stock-movement-form>
}

